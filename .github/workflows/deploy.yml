name: Production Deployment (Transfer)
on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Deploy
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_DEPLOY_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Transfer Code and Deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: deployer
          key: ${{ secrets.SSH_DEPLOY_KEY }}
          script: |
            # 1. Environment Setup
            export DEPLOY_DIR="/opt/stacks/portfolio/app"
            export COMPOSE_FILE="$DEPLOY_DIR/compose.yaml"
            
            # 2. Stop containers
            echo "Stopping containers..."
            docker compose -f "$COMPOSE_FILE" down --remove-orphans || true
            
            # 3. Create backup
            echo "Creating backup..."
            cp -r "$DEPLOY_DIR" "$DEPLOY_DIR.backup.$(date +%s)" || true
            
            # 4. Clear deploy directory
            echo "Clearing deploy directory..."
            rm -rf "$DEPLOY_DIR"
            mkdir -p "$DEPLOY_DIR"

      - name: Copy Repository Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: deployer
          key: ${{ secrets.SSH_DEPLOY_KEY }}
          source: "."
          target: "/opt/stacks/portfolio/app"
          rm: false

      - name: Build and Start
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: deployer
          key: ${{ secrets.SSH_DEPLOY_KEY }}
          script: |
            export DEPLOY_DIR="/opt/stacks/portfolio/app"
            export COMPOSE_FILE="$DEPLOY_DIR/../compose.yaml"
            
            cd "$DEPLOY_DIR"
            echo "moving compose.yaml to parent directory..."
            mv "$DEPLOY_DIR/compose.yaml" "$DEPLOY_DIR/../compose.yaml"
            
            # Set permissions
            chown -R deployer:deployer "$DEPLOY_DIR"
            
            # Clear Docker cache
            echo "Clearing Docker cache..."
            docker system prune -af --volumes
            docker builder prune -af
            
            # Force rebuild
            echo "Building application..."
            export DOCKER_BUILDKIT=1
            export CACHEBUST=$(date +%s)
            export BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            docker compose -f "$COMPOSE_FILE" build \
              --no-cache \
              --pull \
              --build-arg CACHEBUST=$CACHEBUST \
              --build-arg BUILD_TIME="$BUILD_TIME"
            
            # Start services
            echo "Starting services..."
            docker compose -f "$COMPOSE_FILE" up -d
            
            # Wait and verify
            echo "Waiting for services..."
            sleep 20
            
            echo "Container status:"
            docker compose -f "$COMPOSE_FILE" ps
            
            echo "Recent logs:"
            docker compose -f "$COMPOSE_FILE" logs --tail=20
            
            # Health check
            curl -sSf https://fleischer.design > /dev/null && echo "✅ Site is accessible" || echo "❌ Site check failed"
            
            # Cleanup old backups (keep last 3)
            find /opt/stacks -name "portfolio.backup.*" -type d | sort | head -n -3 | xargs rm -rf