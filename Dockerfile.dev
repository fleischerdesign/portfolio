FROM nixos/nix:latest AS development

WORKDIR /app

# Copy the flake files first to leverage Docker layer caching
COPY flake.nix flake.lock ./

# Install all development dependencies from the flake.
# This will populate the Nix store inside the container.
# We run a simple command like "true" to trigger the shell creation.
RUN nix develop --extra-experimental-features "nix-command flakes" --command true

# Copy the rest of the application code
COPY . .

# Mark the repository directory as safe for git operations
RUN git config --global --add safe.directory /app

RUN nix develop --extra-experimental-features "nix-command flakes" --command npm install

EXPOSE 3000

# This will start the Nuxt dev server inside the Nix environment.
CMD ["nix", "develop", "--extra-experimental-features", "nix-command flakes", "--command", "npm", "run", "dev"]
